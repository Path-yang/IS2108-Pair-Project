{% extends "base.html" %}
{% load static %}
{% block title %}Shop Products · AuroraMart{% endblock %}
{% block content %}
<header style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
    <div>
        <h1>Shop the catalogue</h1>
        {% if show_recommendations and onboarding_category %}
            <p>Showing recommendations for you: <strong>{{ onboarding_category }}</strong></p>
        {% elif highlight_category %}
            <p>Recommended for you: <strong>{{ highlight_category }}</strong></p>
        {% else %}
            <p class="muted">Filter by category or search for a product.</p>
        {% endif %}
    </div>
    <div style="display:flex; gap:0.75rem; align-items:center;">
        {% if onboarding_category %}
            <button id="toggleRecommendations" class="button" style="background:#047857;">
                <span id="toggleText">{% if show_recommendations %}Show All Products{% else %}Show Recommendations{% endif %}</span>
            </button>
        {% endif %}
        <a class="button" href="{% url 'storefront:cart' %}">View cart</a>
    </div>
</header>

<form method="get" class="card form-grid" style="margin-bottom:1.5rem;">
    {{ filter_form.as_p }}
    <button type="submit">Apply filters</button>
</form>

<section class="card-grid">
    {% for product in products %}
        <article class="card">
            <img src="{% static 'images/product-placeholder.svg' %}" alt="{{ product.name }}" style="width:100%; height:200px; object-fit:cover; border-radius:0.5rem; margin-bottom:1rem; background:#f3f4f6;">
            <h3>{{ product.name }}</h3>
            <p class="muted">{{ product.category.name }}{% if product.subcategory %} › {{ product.subcategory.name }}{% endif %}</p>
            <p style="font-weight:700;">${{ product.unit_price }}</p>
            <p>{% if product.quantity_on_hand > 0 %}In stock{% else %}<span style="color:#b91c1c;">Out of stock</span>{% endif %}</p>
            <a class="button" href="{% url 'storefront:product_detail' product.sku %}">View details</a>
        </article>
    {% empty %}
        <p>No products match your filters yet.</p>
    {% endfor %}
</section>

{% if is_paginated %}
    <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:0.75rem;">
        {% if page_obj.has_previous %}
            <a class="button" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Previous</a>
        {% endif %}
        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
            <a class="button" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Next</a>
        {% endif %}
    </div>
{% endif %}

{% if next_best_action %}
<section class="card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:1.5rem; margin-top:2rem; border-radius:0.5rem;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
        <div>
            <h2 style="color:white; margin:0 0 0.5rem 0; font-size:1.5rem;">✨ Explore Other Categories</h2>
            <p style="color:rgba(255,255,255,0.9); margin:0;">Discover products from different categories you might love</p>
        </div>
    </div>
    <div class="card-grid" style="grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
        {% for product in next_best_action %}
            <article class="card" style="background:white; color:inherit;">
                <img src="{% static 'images/product-placeholder.svg' %}" alt="{{ product.name }}" style="width:100%; height:150px; object-fit:cover; border-radius:0.5rem; margin-bottom:0.75rem; background:#f3f4f6;">
                <h3 style="color:#1f2937; margin:0 0 0.5rem 0;">{{ product.name }}</h3>
                <p class="muted" style="color:#6b7280; font-size:0.875rem; margin:0.25rem 0;">{{ product.category.name }}</p>
                <p style="font-weight:700; color:#1f2937; margin:0.5rem 0;">${{ product.unit_price|floatformat:2 }}</p>
                <a class="button" href="{% url 'storefront:product_detail' product.sku %}" style="background:#667eea; color:white; text-decoration:none; display:inline-block; padding:0.5rem 1rem; border-radius:0.25rem; text-align:center;">View details</a>
            </article>
        {% endfor %}
    </div>
</section>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle recommendations functionality
    {% if onboarding_category %}
    const toggleBtn = document.getElementById('toggleRecommendations');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            fetch('{% url "storefront:toggle_recommendations" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error toggling recommendations:', error);
            });
        });
    }
    {% endif %}
    
    // Dynamic subcategory filtering based on category selection
    const categorySelect = document.getElementById('id_category');
    const subcategorySelect = document.getElementById('id_subcategory');
    
    if (categorySelect && subcategorySelect) {
        // Store all subcategories data grouped by category
        const allSubcategories = {};
        {% for subcat in all_subcategories %}
        if (!allSubcategories[{{ subcat.category.id }}]) {
            allSubcategories[{{ subcat.category.id }}] = [];
        }
        allSubcategories[{{ subcat.category.id }}].push({
            id: {{ subcat.id }},
            name: "{{ subcat.name|escapejs }}"
        });
        {% endfor %}
        
        function updateSubcategories() {
            const selectedCategoryId = categorySelect.value;
            const currentSubcategoryId = subcategorySelect.value;
            
            // Clear subcategory options
            subcategorySelect.innerHTML = '<option value="">---------</option>';
            
            if (selectedCategoryId && allSubcategories[selectedCategoryId]) {
                // Add subcategories for selected category
                allSubcategories[selectedCategoryId].forEach(function(subcat) {
                    const option = document.createElement('option');
                    option.value = subcat.id;
                    option.textContent = subcat.name;
                    if (currentSubcategoryId && currentSubcategoryId == subcat.id) {
                        option.selected = true;
                    }
                    subcategorySelect.appendChild(option);
                });
            } else {
                // If no category selected or category has no subcategories, keep it empty
                subcategorySelect.disabled = !selectedCategoryId;
            }
        }
        
        // Update subcategories when category changes
        categorySelect.addEventListener('change', function() {
            // Clear subcategory selection when category changes
            subcategorySelect.value = '';
            updateSubcategories();
        });
        
        // Initialize subcategories on page load
        updateSubcategories();
    }
});
</script>
{% endblock %}
